<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Intellih | Diagn√≥stico e E-book de Automa√ß√£o</title>
  <meta name="description" content="Converse com o assistente da Intellih, receba o e-book gratuito e descubra o que automatizar no seu neg√≥cio.">
  <link rel="stylesheet" href="style.css">

  <!-- Meta Pixel - dupla configura√ß√£o -->
  <script>
    !(function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;
      s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)
    })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

    /* Pixel principal */
    fbq('init','3929736470503988');
    fbq('track','PageView');

    /* Novo pixel exclusivo do fluxo interativo */
    fbq('init','790540353803292');
    fbq('track','PageView');

    /* Evento de engajamento: permaneceu 10s na p√°gina */
    setTimeout(()=>{
      fbq('trackCustom','TimeOnPage10s');
      fbq('trackCustom','TimeOnPage10s',{},{
        eventID:'TimeOnPage10s',
        pixelId:'790540353803292'
      });
    },10000);
  </script>

  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=3929736470503988&ev=PageView&noscript=1"
  /></noscript>
</head>

<body>
  <main class="chat-container">
    <header class="header">
      <div class="avatar" title="Agente Intellih"></div>
      <div class="title">
        <h1>Assistente Intellih <span class="status-dot"></span></h1>
        <p id="status-text">Online</p>
      </div>
    </header>

    <div id="chat-box" class="chat-box"></div>

    <footer class="footer">
      Intellih Tecnologia ¬© 2025
    </footer>
  </main>

  <div class="intellih-badge">
    <a href="https://www.intellih.com.br" target="_blank" rel="noopener">
      <img src="assets/logo-intellih.png" alt="Intellih Logo">
      <span>Criado por <strong>Intellih</strong></span>
    </a>
  </div>

  <script>
    window.__INTELLIH__ = {
      WEBAPP_URL: "https://script.google.com/macros/s/AKfycbweW56yedcnradB33gIRs6Sw1CfmvbLdbnAlogXfHHGYGnjs4CXZS2AEMpvrGkOsyB4/exec",
      EBOOK_URL: "https://fluxo.intellih.com.br/e-books/ebook-automacao-inteligente.pdf",
      SECRET_KEY: "INTELLIH2025"
    };
  </script>

  <script>
  const chatBox = document.getElementById("chat-box");
  const statusDot = document.querySelector(".status-dot");
  const statusText = document.getElementById("status-text");

  const CFG = (window.__INTELLIH__ || {});
  const WEBAPP_URL = CFG.WEBAPP_URL || "";
  const EBOOK_URL  = CFG.EBOOK_URL  || "";
  const SECRET_KEY = CFG.SECRET_KEY || "INTELLIH2025";

  const PIXEL_MAIN = "3929736470503988";
  const PIXEL_SECOND = "790540353803292";

  const delay = (ms)=>new Promise(r=>setTimeout(r,ms));

  function dualTrack(event, type='track', payload={}){
    fbq(type, event, payload);
    fbq(type, event, payload, {eventID:event, pixelId:PIXEL_SECOND});
  }

  function dualTrackCustom(event, payload={}){
    fbq('trackCustom', event, payload);
    fbq('trackCustom', event, payload, {eventID:event, pixelId:PIXEL_SECOND});
  }

  async function bubble(text, from='bot'){
    const wrap = document.createElement('div');
    wrap.className = 'message ' + (from==='user'?'user':'bot');
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
    bubble.innerHTML = text;
  }

  function buttons(arr){
    const div=document.createElement('div');
    div.className='buttons';
    arr.forEach(({label,onClick})=>{
      const b=document.createElement('button');
      b.textContent=label;
      b.onclick=()=>{
        dualTrackCustom('BotInteraction');
        div.remove();
        onClick();
      };
      div.appendChild(b);
    });
    chatBox.appendChild(div);
    chatBox.scrollTop=chatBox.scrollHeight;
  }

  function inputField(type='text',placeholder='Digite aqui...'){
    const inp=document.createElement('input');
    inp.type=type; inp.placeholder=placeholder;
    inp.addEventListener('focus',()=>dualTrackCustom('BotInteraction'));
    chatBox.appendChild(inp);
    chatBox.scrollTop=chatBox.scrollHeight;
    return inp;
  }

  // ===== NOVO FLUXO INICIAL =====
  async function start(){
    await bubble('Ol√°! üëã Eu sou a assistente da Intellih.');
    await bubble('Antes de come√ßarmos, posso te enviar gratuitamente o e-book <b>"Automa√ß√£o Inteligente para Pequenos Neg√≥cios"</b>?');
    await bubble('Nele voc√™ vai descobrir, com exemplos reais, como automatizar partes do seu neg√≥cio e economizar tempo.');
    buttons([
      {label:'Sim, quero o e-book üìò', onClick:()=>{dualTrackCustom('LeadIntent'); faseNome('Ebook');}},
      {label:'Prefiro conversar primeiro', onClick:()=>faseDiagnostico()}
    ]);
  }

  async function faseNome(tipo){
    await bubble('Perfeito! Me diga seu nome para eu te enviar o e-book:');
    const inp=inputField('text','Digite seu nome completo');
    buttons([{label:'Pr√≥ximo',onClick:()=>faseEmail(tipo,(inp.value||'').trim())}]);
  }

  async function faseEmail(tipo,nome){
    if(!nome){await bubble('Por favor, digite seu nome antes de continuar.');return;}
    await bubble(`√ìtimo, ${nome}! Agora digite seu e-mail:`);
    const inp=inputField('email','voce@empresa.com');
    buttons([{label:'Receber e-book',onClick:()=>enviar(nome,(inp.value||'').trim(),tipo,true)}]);
  }

  // Mant√©m o fluxo de diagn√≥stico ap√≥s o e-book
  async function faseDiagnostico(){
    await bubble('Perfeito! Esta conversa √© uma demonstra√ß√£o pr√°tica do que automa√ß√µes inteligentes e agentes de IA podem fazer pelo seu neg√≥cio.');
    await bubble('Quer descobrir, na pr√°tica, o que automatizar na sua empresa com IA?');
    buttons([
      {label:'Sim, quero!', onClick:()=>fasePerfil()},
      {label:'Quero ver exemplos primeiro', onClick:faseExemplos}
    ]);
  }

  async function fasePerfil(){
    await bubble('Me diga com qual perfil voc√™ mais se identifica:');
    buttons([
      {label:'Empreendedor(a)', onClick:()=>faseNome('Empreendedor')},
      {label:'Aut√¥nomo(a)', onClick:()=>faseNome('Aut√¥nomo')},
      {label:'Curioso(a) sobre IA', onClick:()=>faseNome('Curioso')}
    ]);
  }

  async function faseExemplos(){
    await bubble('Veja alguns exemplos de automa√ß√µes que implementamos:');
    await bubble('‚Ä¢ Capta√ß√£o autom√°tica de leads<br>‚Ä¢ Atendimento inteligente no WhatsApp<br>‚Ä¢ Relat√≥rios e an√°lises com IA<br>‚Ä¢ Agendamentos autom√°ticos');
    buttons([{label:'Quero meu diagn√≥stico gratuito', onClick:()=>faseNome('Interessado')}]);
  }

  async function enviar(nome,email,tipo,ebookOptIn){
    dualTrack('Lead');
    await bubble('Processando suas informa√ß√µes...');
    const params=new URLSearchParams(window.location.search);
    const origem={
      utm_source:params.get("utm_source")||"direto",
      utm_medium:params.get("utm_medium")||"nao_definido",
      utm_campaign:params.get("utm_campaign")||"nao_definido"
    };

    try{
      const res=await fetch(WEBAPP_URL,{
        method:'POST',
        body:JSON.stringify({nome,email,tipo,ebookOptIn,token:SECRET_KEY,...origem})
      });
      const text=await res.text();
      if(res.ok && text.includes('OK')){
        dualTrack('CompleteRegistration');
        await bubble(`Perfeito, ${nome}!`);
        if(ebookOptIn && EBOOK_URL){
          dualTrackCustom('DownloadEbook');
          await bubble('Enviei o e-book para o seu e-mail. Voc√™ tamb√©m pode acessar agora:');
          await bubble(`<a href="${EBOOK_URL}" target="_blank" rel="noopener">üìò Baixar e-book Automa√ß√£o Inteligente</a>`);
          await bubble('Quer que eu te mostre tamb√©m ideias de automa√ß√£o personalizadas?');
          buttons([{label:'Sim, quero ver', onClick:faseDiagnostico}]);
        } else {
          await bubble('Tudo certo! Voc√™ receber√° seu diagn√≥stico gratuito em at√© 24 horas.');
        }
      } else {
        await bubble('Ocorreu um erro ao enviar seus dados. Tente novamente mais tarde.');
      }
    } catch(err){
      console.error(err);
      await bubble('Falha de comunica√ß√£o com o servidor.');
    }
  }

  start();
  </script>
</body>
</html>
