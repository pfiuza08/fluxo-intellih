<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Intellih | Diagnóstico de Automação</title>
  <meta name="description" content="Converse com o assistente da Intellih e descubra o que automatizar no seu negócio.">
  <link rel="stylesheet" href="style.css">

  <!-- Meta Pixel -->
  <script>
    !(function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;
      s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)
    })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init','3929736470503988');
    fbq('track','PageView');
  </script>
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=3929736470503988&ev=PageView&noscript=1"
  /></noscript>
</head>

<body>
  <main class="chat-container">
    <header class="header">
      <div class="avatar" title="Agente Intellih"></div>
      <div class="title">
        <h1>Assistente Intellih</h1>
        <p>Diagnóstico de Automação Inteligente</p>
      </div>
    </header>

    <div id="chat-box" class="chat-box"></div>

    <footer class="footer">
      Intellih Tecnologia © 2025
    </footer>
  </main>

  <!-- CONFIGURAÇÕES GLOBAIS -->
  <script>
    window.__INTELLIH__ = {
      WEBAPP_URL: "https://script.google.com/macros/s/AKfycbweW56yedcnradB33gIRs6Sw1CfmvbLdbnAlogXfHHGYGnjs4CXZS2AEMpvrGkOsyB4/exec",
      EBOOK_URL: "https://fluxo.intellih.com.br/e-books/ebook-automacao-inteligente.pdf",
      SECRET_KEY: "INTELLIH2025"
    };
  </script>

  <script>
  const chatBox = document.getElementById("chat-box");
  const CFG = (window.__INTELLIH__ || {});
  const WEBAPP_URL = CFG.WEBAPP_URL || "";
  const EBOOK_URL  = CFG.EBOOK_URL  || "";
  const SECRET_KEY = CFG.SECRET_KEY || "INTELLIH2025";

  const delay = (ms)=>new Promise(r=>setTimeout(r,ms));

  // --- Efeito de digitação no texto das bolhas ---
  async function typeText(element, text) {
    const speed = 15;
    for (let i = 0; i < text.length; i++) {
      element.innerHTML = text.substring(0, i + 1);
      chatBox.scrollTop = chatBox.scrollHeight;
      await delay(speed);
    }
  }

  async function bubble(text, from='bot'){
    removeTyping();
    const wrap = document.createElement('div');
    wrap.className = 'message ' + (from==='user'?'user':'bot');
    const avatar = from==='bot'?'<div class="avatar"></div>':'';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    wrap.innerHTML = avatar;
    wrap.appendChild(bubble);
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
    await typeText(bubble, text);
  }

  function showTyping(){
    removeTyping();
    const typing = document.createElement('div');
    typing.className = 'message bot typing-indicator';
    typing.innerHTML = `
      <div class="avatar"></div>
      <div class="bubble typing">
        <span></span><span></span><span></span>
      </div>`;
    chatBox.appendChild(typing);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function removeTyping(){
    const old = document.querySelector('.typing-indicator');
    if(old) old.remove();
  }

  function buttons(arr){
    const div=document.createElement('div');
    div.className='buttons';
    arr.forEach(({label,onClick})=>{
      const b=document.createElement('button');
      b.textContent=label;
      b.onclick=()=>{div.remove();onClick();};
      div.appendChild(b);
    });
    chatBox.appendChild(div);
    chatBox.scrollTop=chatBox.scrollHeight;
  }

  function inputField(type='text',placeholder='Digite aqui...'){
    const inp=document.createElement('input');
    inp.type=type; inp.placeholder=placeholder;
    chatBox.appendChild(inp);
    chatBox.scrollTop=chatBox.scrollHeight;
    return inp;
  }

  // --- Fluxo principal ---
  async function start(){
    showTyping(); await delay(600);
    await bubble('Olá! Eu sou o assistente da Intellih.');
    showTyping(); await delay(600);
    await bubble('Quer descobrir como automatizar seu negócio com Inteligência Artificial?');
    buttons([
      {label:'Sim, quero!', onClick:()=>{fasePerfil();}},
      {label:'Quero ver exemplos', onClick:faseExemplos}
    ]);
  }

  async function fasePerfil(){
    showTyping(); await delay(400);
    await bubble('Perfeito! Me diga com qual perfil você mais se identifica:');
    buttons([
      {label:'Empreendedor(a)', onClick:()=>faseNome('Empreendedor')},
      {label:'Autônomo(a)', onClick:()=>faseNome('Autônomo')},
      {label:'Curioso(a) sobre IA', onClick:()=>faseNome('Curioso')}
    ]);
  }

  async function faseExemplos(){
    showTyping(); await delay(400);
    await bubble('Veja alguns exemplos de automações que aplicamos:');
    showTyping(); await delay(400);
    await bubble('• Captação automática de leads<br>• Atendimento inteligente via WhatsApp<br>• Relatórios e análises com IA');
    buttons([{label:'Quero meu diagnóstico', onClick:()=>faseNome('Interessado')}]);
  }

  async function faseNome(tipo){
    showTyping(); await delay(400);
    await bubble('Qual é o seu nome?');
    const inp=inputField('text','Digite seu nome completo');
    buttons([{label:'Próximo',onClick:()=>faseEmail(tipo,(inp.value||'').trim())}]);
  }

  async function faseEmail(tipo,nome){
    if(!nome){await bubble('Por favor, digite seu nome antes de continuar.');return;}
    showTyping(); await delay(400);
    await bubble(`Ótimo, ${nome}! Agora me diga seu e-mail:`);
    const inp=inputField('email','voce@empresa.com');
    buttons([{label:'Próximo',onClick:()=>faseEbook(tipo,nome,(inp.value||'').trim())}]);
  }

  async function faseEbook(tipo,nome,email){
    if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
      await bubble('E-mail inválido. Tente novamente.');
      return;
    }
    showTyping(); await delay(400);
    await bubble('Deseja receber também o e-book "Automação Inteligente"?');
    buttons([
      {label:'Sim, enviar e-book',onClick:()=>enviar(nome,email,tipo,true)},
      {label:'Agora não',onClick:()=>enviar(nome,email,tipo,false)}
    ]);
  }

  async function enviar(nome,email,tipo,ebookOptIn){
    showTyping(); await delay(600);
    await bubble('Processando suas informações...');
    const params=new URLSearchParams(window.location.search);
    const origem={
      utm_source:params.get("utm_source")||"direto",
      utm_medium:params.get("utm_medium")||"nao_definido",
      utm_campaign:params.get("utm_campaign")||"nao_definido"
    };

    try{
      const res=await fetch(WEBAPP_URL,{
        method:'POST',
        body:JSON.stringify({nome,email,tipo,ebookOptIn,token:SECRET_KEY,...origem})
      });
      const text=await res.text();
      let payload={};try{payload=JSON.parse(text);}catch(_){}
      if(res.ok&&(payload.status==='OK'||text.includes('OK'))){
        showTyping(); await delay(600);
        await bubble(`Obrigado, ${nome}!`);
        if(ebookOptIn&&EBOOK_URL){
          showTyping(); await delay(600);
          await bubble('Enviei um e-mail com o link do e-book. Você também pode acessar por aqui:');
          await bubble(`<a href="${EBOOK_URL}" target="_blank" rel="noopener">Baixar e-book Automação Inteligente</a>`);
        }else{
          await bubble('Tudo certo! Você receberá seu diagnóstico gratuito em até 24 horas.');
        }
      }else{
        await bubble('Ocorreu um erro ao enviar seus dados. Tente novamente em instantes.');
      }
    }catch(err){
      await bubble('Falha de comunicação com o servidor. Verifique sua conexão.');
      console.error(err);
    }
  }

  start();
  </script>
</body>
</html>
