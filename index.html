<script>
/* ====== ELEMENTOS ====== */
const chatBox   = document.getElementById("chat-box");
const statusDot = document.querySelector(".status-dot");
const statusText= document.getElementById("status-text");

/* ====== CONFIG ====== */
const CFG        = (window.__INTELLIH__ || {});
const WEBAPP_URL = CFG.WEBAPP_URL || "";
const EBOOK_URL  = CFG.EBOOK_URL  || "";
const SECRET_KEY = CFG.SECRET_KEY || "INTELLIH2025";

/* Pixels (principal + novo) */
const PIXEL_SECOND = "790540353803292";

/* ====== ESTADO GLOBAL ====== */
const state = {
  nome: "",
  email: "",
  tipo: "",          // Ebook | Empreendedor | Aut√¥nomo | Curioso | Interessado
  ebookOptIn: false, // true quando aceita e-book
  uiLocked: false,   // trava UI durante envios
};

/* ====== HELPERS UI ====== */
function setStatusTyping(isTyping){
  if(!statusDot || !statusText) return;
  if(isTyping){
    statusDot.style.background = "#999";
    statusDot.style.boxShadow  = "0 0 5px rgba(150,150,150,0.5)";
    statusText.textContent     = "Digitando...";
  } else {
    statusDot.style.background = "#3bc23b";
    statusDot.style.transition = "background .6s ease, box-shadow .6s ease";
    statusDot.style.boxShadow  = "0 0 6px rgba(59,194,59,.7)";
    statusText.textContent     = "Online";
  }
}
const delay = (ms)=>new Promise(r=>setTimeout(r,ms));

async function bubble(html, from='bot'){
  setStatusTyping(true);
  const wrap = document.createElement('div');
  wrap.className = 'message ' + (from==='user'?'user':'bot');
  const b = document.createElement('div');
  b.className='bubble';
  b.innerHTML = html;
  wrap.appendChild(b);
  chatBox.appendChild(wrap);
  chatBox.scrollTop = chatBox.scrollHeight;
  await delay(200);
  setStatusTyping(false);
}

/* Remove inputs e bot√µes antigos para evitar repeti√ß√£o */
function clearInteracts(){
  [...chatBox.querySelectorAll('.buttons, input[type="text"], input[type="email"]')].forEach(n=>n.remove());
}

/* Bot√µes one-click com rastreamento */
function buttons(list){
  clearInteracts();
  const box = document.createElement('div');
  box.className = 'buttons';
  list.forEach(({label,onClick})=>{
    const btn = document.createElement('button');
    btn.textContent = label;
    btn.onclick = ()=>{
      if(state.uiLocked) return;
      fbq('trackCustom','BotInteraction');
      box.querySelectorAll('button').forEach(b=>b.disabled=true); // evita duplo clique
      onClick();
      box.remove();
    };
    box.appendChild(btn);
  });
  chatBox.appendChild(box);
  chatBox.scrollTop = chatBox.scrollHeight;
}

/* Campos */
function inputField(type='text', placeholder='Digite aqui...'){
  const inp = document.createElement('input');
  inp.type = type;
  inp.placeholder = placeholder;
  inp.addEventListener('focus',()=>fbq('trackCustom','BotInteraction'));
  chatBox.appendChild(inp);
  chatBox.scrollTop = chatBox.scrollHeight;
  return inp;
}

/* ====== GUARDI√ÉS DE PERGUNTAS ====== */
function askNameIfNeeded(next){
  if(state.nome && state.nome.trim()){
    return next();
  }
  clearInteracts();
  bubble('Qual √© o seu nome?').then(()=>{
    const inp = inputField('text','Digite seu nome completo');
    buttons([{label:'Pr√≥ximo', onClick:()=>{
      const v = (inp.value||'').trim();
      if(!v){ bubble('Por favor, digite seu nome antes de continuar.'); return; }
      state.nome = v;
      next();
    }}]);
  });
}

function askEmailIfNeeded(next){
  if(state.email && /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(state.email)){
    return next();
  }
  clearInteracts();
  bubble(`√ìtimo, ${state.nome.split(' ')[0]||'tudo bem'}! Qual √© o seu e-mail?`).then(()=>{
    const inp = inputField('email','voce@empresa.com');
    buttons([{label:'Pr√≥ximo', onClick:()=>{
      const v = (inp.value||'').trim();
      if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v)){ bubble('E-mail inv√°lido. Tente novamente.'); return; }
      state.email = v;
      next();
    }}]);
  });
}

/* ====== FLUXO ====== */
async function start(){
  await bubble('Ol√°! üëã Eu sou a assistente da Intellih.');
  await bubble('Antes de come√ßarmos, posso te enviar gratuitamente o e-book <b>"Automa√ß√£o Inteligente para Pequenos Neg√≥cios"</b>?');
  await bubble('Nele voc√™ v√™, com exemplos reais, o que pode automatizar ainda hoje.');
  buttons([
    {label:'Sim, quero o e-book', onClick:()=>{
      fbq('trackCustom','LeadIntent');
      state.tipo = 'Ebook';
      state.ebookOptIn = true;
      askNameIfNeeded(()=>askEmailIfNeeded(()=>submitLeadThenInviteDiag()));
    }},
    {label:'Prefiro conversar primeiro', onClick:()=>diagnosticoIntro()}
  ]);
}

/* Intro do diagn√≥stico (sem repetir nome/email se j√° tiver) */
async function diagnosticoIntro(){
  await bubble('Esta conversa √© uma demonstra√ß√£o pr√°tica do que automa√ß√µes inteligentes e agentes de IA podem fazer pelo seu neg√≥cio.');
  await bubble('Quer descobrir, na pr√°tica, o que automatizar na sua empresa com IA?');
  buttons([
    {label:'Sim, quero!', onClick:()=>perfil()},
    {label:'Quero ver exemplos primeiro', onClick:()=>exemplos()}
  ]);
}

function perfil(){
  bubble('Com qual perfil voc√™ mais se identifica?');
  buttons([
    {label:'Empreendedor(a)', onClick:()=>{state.tipo='Empreendedor'; coletarSeNecessarioEEnviar();}},
    {label:'Aut√¥nomo(a)',     onClick:()=>{state.tipo='Aut√¥nomo';     coletarSeNecessarioEEnviar();}},
    {label:'Curioso(a) sobre IA', onClick:()=>{state.tipo='Curioso';  coletarSeNecessarioEEnviar();}},
    {label:'Interessado',     onClick:()=>{state.tipo='Interessado';  coletarSeNecessarioEEnviar();}}
  ]);
}

function exemplos(){
  bubble('Exemplos que implementamos:');
  bubble('‚Ä¢ Capta√ß√£o autom√°tica de leads<br>‚Ä¢ Atendimento inteligente no WhatsApp<br>‚Ä¢ Relat√≥rios e an√°lises com IA<br>‚Ä¢ Agendamentos autom√°ticos').then(()=>{
    buttons([{label:'Quero meu diagn√≥stico gratuito', onClick:()=>{state.tipo='Interessado'; coletarSeNecessarioEEnviar();}}]);
  });
}

/* Coleta nome/email apenas se ainda n√£o houver, depois envia */
function coletarSeNecessarioEEnviar(){
  askNameIfNeeded(()=>askEmailIfNeeded(()=>enviarLead(false)));
}

/* Ap√≥s enviar e-book com sucesso, convidar para diagn√≥stico */
async function submitLeadThenInviteDiag(){
  await enviarLead(true);
  await bubble('Quer que eu te mostre tamb√©m ideias de automa√ß√£o personalizadas agora?');
  buttons([
    {label:'Sim, mostrar ideias', onClick:()=>diagnosticoIntro()},
    {label:'Agora n√£o', onClick:()=>bubble('Perfeito! Qualquer d√∫vida, √© s√≥ me chamar aqui.')}
  ]);
}

/* ====== ENVIO ====== */
async function enviarLead(fromEbook){
  if(state.uiLocked) return;
  state.uiLocked = true;

  // Evento de Lead para ambos os pixels
  fbq('track','Lead');
  fbq('track','Lead',{}, {eventID:'Lead', pixelId: PIXEL_SECOND});

  await bubble('Processando suas informa√ß√µes...');

  // UTMs
  const params = new URLSearchParams(window.location.search);
  const origem = {
    utm_source:   params.get("utm_source")   || "direto",
    utm_medium:   params.get("utm_medium")   || "nao_definido",
    utm_campaign: params.get("utm_campaign") || "nao_definido"
  };

  try{
    const payload = {
      nome: state.nome,
      email: state.email,
      tipo: state.tipo || (fromEbook ? 'Ebook' : 'Diagn√≥stico'),
      ebookOptIn: !!state.ebookOptIn,
      token: SECRET_KEY,
      ...origem
    };

    const res  = await fetch(WEBAPP_URL,{ method:'POST', body: JSON.stringify(payload) });
    const text = await res.text();

    if(res.ok && (text.includes('OK') || safeJsonOK(text))){
      // CompleteRegistration para ambos
      fbq('track','CompleteRegistration');
      fbq('track','CompleteRegistration',{}, {eventID:'CompleteRegistration', pixelId: PIXEL_SECOND});

      await bubble(`Perfeito, ${state.nome.split(' ')[0]}!`);

      if(state.ebookOptIn && EBOOK_URL){
        // DownloadEbook para ambos
        fbq('trackCustom','DownloadEbook');
        fbq('trackCustom','DownloadEbook',{}, {eventID:'DownloadEbook', pixelId: PIXEL_SECOND});

        await bubble('Enviei o e-book para o seu e-mail. Voc√™ tamb√©m pode acessar agora:');
        await bubble(`<a href="${EBOOK_URL}" target="_blank" rel="noopener">üìò Baixar e-book Automa√ß√£o Inteligente</a>`);
      } else {
        await bubble('Tudo certo! Seu diagn√≥stico ser√° enviado em breve.');
      }
    } else {
      await bubble('Ocorreu um erro ao enviar seus dados. Tente novamente mais tarde.');
    }
  } catch(err){
    console.error(err);
    await bubble('Falha de comunica√ß√£o com o servidor.');
  } finally {
    state.uiLocked = false;
  }
}

/* Utilit√°rio para tentar interpretar JSON do Apps Script */
function safeJsonOK(text){
  try{
    const j = JSON.parse(text);
    return j && j.status === 'OK';
  }catch(_){ return false; }
}

/* ====== START ====== */
start();
</script>
