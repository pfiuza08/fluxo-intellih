<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assistente Intellih | Diagnóstico e E-book de Automação</title>
  <meta name="description" content="Converse com o assistente da Intellih, receba o e-book gratuito e descubra o que automatizar no seu negócio.">
  <link rel="stylesheet" href="style.css">

  <!-- Meta Pixel - dupla configuração -->
  <script>
    !(function(f,b,e,v,n,t,s){
      if(f.fbq)return;n=f.fbq=function(){n.callMethod?
      n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;
      s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)
    })(window, document, 'script', 'https://connect.facebook.net/en_US/fbevents.js');

    fbq('init','3929736470503988');
    fbq('track','PageView');
    fbq('init','790540353803292');
    fbq('track','PageView');

    setTimeout(()=>{
      fbq('trackCustom','TimeOnPage10s');
      fbq('trackCustom','TimeOnPage10s',{},{
        eventID:'TimeOnPage10s',
        pixelId:'790540353803292'
      });
    },10000);
  </script>

  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=3929736470503988&ev=PageView&noscript=1"
  /></noscript>
</head>

<body>
  <main class="chat-container">
    <header class="header">
      <div class="avatar" title="Agente Intellih"></div>
      <div class="title">
        <h1>Assistente Intellih <span class="status-dot"></span></h1>
        <p id="status-text">Online</p>
      </div>
    </header>

    <div id="chat-box" class="chat-box"></div>

    <footer class="footer">
      Intellih Tecnologia © 2025
    </footer>
  </main>

  <div class="intellih-badge">
    <a href="https://www.intellih.com.br" target="_blank" rel="noopener">
      <img src="assets/logo-intellih.png" alt="Intellih Logo">
      <span>Criado por <strong>Intellih</strong></span>
    </a>
  </div>

  <script>
    window.__INTELLIH__ = {
      WEBAPP_URL: "https://script.google.com/macros/s/AKfycbweW56yedcnradB33gIRs6Sw1CfmvbLdbnAlogXfHHGYGnjs4CXZS2AEMpvrGkOsyB4/exec",
      EBOOK_URL: "https://fluxo.intellih.com.br/e-books/ebook-automacao-inteligente.pdf",
      SECRET_KEY: "INTELLIH2025"
    };
  </script>

  <!-- SCRIPT CORRIGIDO -->
  <script>
  const chatBox = document.getElementById("chat-box");
  const statusDot = document.querySelector(".status-dot");
  const statusText = document.getElementById("status-text");

  const CFG = window.__INTELLIH__ || {};
  const WEBAPP_URL = CFG.WEBAPP_URL;
  const EBOOK_URL  = CFG.EBOOK_URL;
  const SECRET_KEY = CFG.SECRET_KEY;

  const PIXEL_SECOND = "790540353803292";

  // segurança: fbqSafe evita erro se Pixel bloqueado
  function fbqSafe(...args){ try{ fbq(...args); }catch(e){} }

  const state = { nome:"", email:"", tipo:"", ebookOptIn:false, uiLocked:false };

  const delay = (ms)=>new Promise(r=>setTimeout(r,ms));

  async function bubble(text, from='bot'){
    const wrap=document.createElement('div');
    wrap.className='message '+(from==='user'?'user':'bot');
    const b=document.createElement('div');
    b.className='bubble';
    b.innerHTML=text;
    wrap.appendChild(b);
    chatBox.appendChild(wrap);
    chatBox.scrollTop=chatBox.scrollHeight;
    await delay(200);
  }

  function clearInputs(){ [...chatBox.querySelectorAll('input, .buttons')].forEach(e=>e.remove()); }

  function buttons(list){
    clearInputs();
    const box=document.createElement('div');
    box.className='buttons';
    list.forEach(({label,onClick})=>{
      const btn=document.createElement('button');
      btn.textContent=label;
      btn.onclick=()=>{
        if(state.uiLocked) return;
        fbqSafe('trackCustom','BotInteraction');
        fbqSafe('trackCustom','BotInteraction',{}, {eventID:'BotInteraction',pixelId:PIXEL_SECOND});
        box.querySelectorAll('button').forEach(b=>b.disabled=true);
        onClick();
      };
      box.appendChild(btn);
    });
    chatBox.appendChild(box);
    chatBox.scrollTop=chatBox.scrollHeight;
  }

  function inputField(type='text',placeholder='Digite aqui...'){
    const inp=document.createElement('input');
    inp.type=type; inp.placeholder=placeholder;
    chatBox.appendChild(inp);
    chatBox.scrollTop=chatBox.scrollHeight;
    return inp;
  }

  function askName(next){
    if(state.nome) return next();
    clearInputs();
    bubble("Qual é o seu nome?").then(()=>{
      const inp=inputField('text','Digite seu nome completo');
      buttons([{label:'Próximo',onClick:()=>{
        const v=(inp.value||'').trim();
        if(!v) return bubble('Por favor, digite seu nome antes de continuar.');
        state.nome=v;
        next();
      }}]);
    });
  }

  function askEmail(next){
    const emailOk=v=>/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(v);
    if(state.email && emailOk(state.email)) return next();
    clearInputs();
    bubble(`Ótimo, ${state.nome.split(' ')[0]||''}! Qual é o seu e-mail?`).then(()=>{
      const inp=inputField('email','voce@empresa.com');
      buttons([{label:'Próximo',onClick:()=>{
        const v=(inp.value||'').trim();
        if(!emailOk(v)) return bubble('E-mail inválido. Tente novamente.');
        state.email=v;
        next();
      }}]);
    });
  }

  async function start(){
    await bubble('Olá! Eu sou a assistente da Intellih.');
    await bubble('Antes de começarmos, posso te enviar gratuitamente o e-book <b>"Automação Inteligente para Pequenos Negócios"</b>?');
    await bubble('Nele você vai descobrir, com exemplos reais, como automatizar partes do seu negócio.');
    buttons([
      {label:'Sim, quero o e-book', onClick:()=>{
        fbqSafe('trackCustom','LeadIntent');
        fbqSafe('trackCustom','LeadIntent',{}, {eventID:'LeadIntent',pixelId:PIXEL_SECOND});
        state.tipo='Ebook'; state.ebookOptIn=true;
        askName(()=>askEmail(()=>enviarLead(true)));
      }},
      {label:'Prefiro conversar primeiro', onClick:()=>faseDiagnostico()}
    ]);
  }

  async function faseDiagnostico(){
    await bubble('Esta conversa é uma demonstração prática do que automações inteligentes e agentes de IA podem fazer pelo seu negócio.');
    await bubble('Quer descobrir, na prática, o que automatizar na sua empresa com IA?');
    buttons([
      {label:'Sim, quero!', onClick:()=>fasePerfil()},
      {label:'Quero ver exemplos primeiro', onClick:()=>faseExemplos()}
    ]);
  }

  async function fasePerfil(){
    await bubble('Com qual perfil você mais se identifica?');
    buttons([
      {label:'Empreendedor(a)', onClick:()=>{state.tipo='Empreendedor'; coletarDados();}},
      {label:'Autônomo(a)', onClick:()=>{state.tipo='Autônomo'; coletarDados();}},
      {label:'Curioso(a)', onClick:()=>{state.tipo='Curioso'; coletarDados();}}
    ]);
  }

  async function faseExemplos(){
    await bubble('Veja alguns exemplos de automações que implementamos:');
    await bubble('• Captação automática de leads<br>• Atendimento inteligente no WhatsApp<br>• Relatórios e análises com IA<br>• Agendamentos automáticos');
    buttons([{label:'Quero meu diagnóstico gratuito', onClick:()=>{state.tipo='Interessado'; coletarDados();}}]);
  }

  function coletarDados(){ askName(()=>askEmail(()=>enviarLead(false))); }

  async function enviarLead(fromEbook){
    if(state.uiLocked) return;
    state.uiLocked=true;
    fbqSafe('track','Lead');
    fbqSafe('track','Lead',{}, {eventID:'Lead',pixelId:PIXEL_SECOND});
    await bubble('Processando suas informações...');

    const params=new URLSearchParams(window.location.search);
    const origem={
      utm_source:params.get("utm_source")||"direto",
      utm_medium:params.get("utm_medium")||"nao_definido",
      utm_campaign:params.get("utm_campaign")||"nao_definido"
    };

    try{
      const res=await fetch(WEBAPP_URL,{
        method:'POST',
        body:JSON.stringify({
          nome:state.nome,email:state.email,
          tipo:state.tipo||'Diagnóstico',ebookOptIn:state.ebookOptIn,
          token:SECRET_KEY,...origem
        })
      });
      const text=await res.text();
      if(res.ok && text.includes('OK')){
        fbqSafe('track','CompleteRegistration');
        fbqSafe('track','CompleteRegistration',{}, {eventID:'CompleteRegistration',pixelId:PIXEL_SECOND});
        await bubble(`Perfeito, ${state.nome.split(' ')[0]}!`);
        if(state.ebookOptIn && EBOOK_URL){
          fbqSafe('trackCustom','DownloadEbook');
          fbqSafe('trackCustom','DownloadEbook',{}, {eventID:'DownloadEbook',pixelId:PIXEL_SECOND});
          await bubble('Enviei o e-book para o seu e-mail. Você também pode acessar agora:');
          await bubble(`<a href="${EBOOK_URL}" target="_blank" rel="noopener">Baixar e-book Automação Inteligente</a>`);
          await bubble('Quer que eu te mostre também ideias de automação personalizadas?');
          buttons([{label:'Sim, quero ver',onClick:()=>faseDiagnostico()}]);
        }else{
          await bubble('Tudo certo! Você receberá seu diagnóstico gratuito em até 24 horas.');
        }
      } else {
        await bubble('Ocorreu um erro ao enviar seus dados. Tente novamente mais tarde.');
      }
    }catch(err){
      console.error(err);
      await bubble('Falha de comunicação com o servidor.');
    }finally{
      state.uiLocked=false;
    }
  }

  document.addEventListener('DOMContentLoaded',()=>start());
  </script>
</body>
</html>
