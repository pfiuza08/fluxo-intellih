<script>
const chatBox = document.getElementById("chat-box");
const statusDot = document.querySelector(".status-dot");
const statusText = document.getElementById("status-text");

const CFG = (window.__INTELLIH__ || {});
const WEBAPP_URL = CFG.WEBAPP_URL || "";
const EBOOK_URL  = CFG.EBOOK_URL  || "";
const SECRET_KEY = CFG.SECRET_KEY || "INTELLIH2025";

// Pixels
const PIXEL_MAIN = "3929736470503988";
const PIXEL_SECOND = "790540353803292";

const delay = (ms)=>new Promise(r=>setTimeout(r,ms));

function dualTrack(event, type='track', payload={}){
  fbq(type, event, payload);
  fbq(type, event, payload, {eventID:event, pixelId:PIXEL_SECOND});
}

function dualTrackCustom(event, payload={}){
  fbq('trackCustom', event, payload);
  fbq('trackCustom', event, payload, {eventID:event, pixelId:PIXEL_SECOND});
}

// üîπ Efeito de digita√ß√£o
async function typingEffect(text, from='bot', speed=25) {
  const wrap = document.createElement('div');
  wrap.className = 'message ' + (from==='user' ? 'user' : 'bot');
  const bubble = document.createElement('div');
  bubble.className = 'bubble typing';
  wrap.appendChild(bubble);
  chatBox.appendChild(wrap);
  chatBox.scrollTop = chatBox.scrollHeight;

  await delay(400 + Math.random()*400); // tempo de "digitando..."
  bubble.classList.remove('typing');

  // digita caractere a caractere
  for (let i = 0; i < text.length; i++) {
    bubble.innerHTML = text.slice(0, i + 1);
    chatBox.scrollTop = chatBox.scrollHeight;
    await delay(speed);
  }
}

function buttons(arr){
  const div=document.createElement('div');
  div.className='buttons';
  arr.forEach(({label,onClick})=>{
    const b=document.createElement('button');
    b.textContent=label;
    b.onclick=()=>{
      dualTrackCustom('BotInteraction');
      div.remove();
      onClick();
    };
    div.appendChild(b);
  });
  chatBox.appendChild(div);
  chatBox.scrollTop=chatBox.scrollHeight;
}

function inputField(type='text',placeholder='Digite aqui...'){
  const inp=document.createElement('input');
  inp.type=type; inp.placeholder=placeholder;
  inp.addEventListener('focus',()=>dualTrackCustom('BotInteraction'));
  chatBox.appendChild(inp);
  chatBox.scrollTop=chatBox.scrollHeight;
  return inp;
}

async function start(){
  await typingEffect('Ol√°! üëã Seja bem-vindo(a) √† Intellih.');
  await typingEffect('Esta conversa √© uma demonstra√ß√£o real do que automa√ß√µes inteligentes e agentes de IA podem fazer pelo seu neg√≥cio.');
  await typingEffect('Quer descobrir, na pr√°tica, o que automatizar na sua empresa com IA e receber um mini e-book sobre automa√ß√£o?');
  buttons([
    {label:'Sim, quero!', onClick:()=>{dualTrackCustom('LeadIntent'); fasePerfil();}},
    {label:'Quero ver exemplos primeiro', onClick:faseExemplos}
  ]);
}

async function fasePerfil(){
  await typingEffect('Perfeito! Me diga com qual perfil voc√™ mais se identifica:');
  buttons([
    {label:'Empreendedor(a)', onClick:()=>faseNome('Empreendedor')},
    {label:'Aut√¥nomo(a)', onClick:()=>faseNome('Aut√¥nomo')},
    {label:'Curioso(a) sobre IA', onClick:()=>faseNome('Curioso')}
  ]);
}

async function faseExemplos(){
  await typingEffect('Veja alguns exemplos de automa√ß√µes que implementamos:');
  await typingEffect('‚Ä¢ Capta√ß√£o autom√°tica de leads<br>‚Ä¢ Atendimento inteligente no WhatsApp<br>‚Ä¢ Relat√≥rios e an√°lises com IA<br>‚Ä¢ Agendamentos autom√°ticos');
  buttons([{label:'Quero meu diagn√≥stico gratuito', onClick:()=>faseNome('Interessado')}]);
}

async function faseNome(tipo){
  await typingEffect('Antes de prosseguirmos, me diga seu nome:');
  const inp=inputField('text','Digite seu nome completo');
  buttons([{label:'Pr√≥ximo',onClick:()=>faseEmail(tipo,(inp.value||'').trim())}]);
}

async function faseEmail(tipo,nome){
  if(!nome){await typingEffect('Por favor, digite seu nome antes de continuar.');return;}
  await typingEffect(`Prazer, ${nome}! Agora me informe seu e-mail:`);
  const inp=inputField('email','voce@empresa.com');
  buttons([{label:'Pr√≥ximo',onClick:()=>faseEbook(tipo,nome,(inp.value||'').trim())}]);
}

async function faseEbook(tipo,nome,email){
  if(!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)){
    await typingEffect('E-mail inv√°lido. Tente novamente.');
    return;
  }
  await typingEffect('Deseja receber tamb√©m o e-book "Automa√ß√£o Inteligente"?');
  buttons([
    {label:'Sim, enviar e-book',onClick:()=>enviar(nome,email,tipo,true)},
    {label:'Agora n√£o',onClick:()=>enviar(nome,email,tipo,false)}
  ]);
}

async function enviar(nome,email,tipo,ebookOptIn){
  dualTrack('Lead');
  await typingEffect('Processando suas informa√ß√µes...');
  const params=new URLSearchParams(window.location.search);
  const origem={
    utm_source:params.get("utm_source")||"direto",
    utm_medium:params.get("utm_medium")||"nao_definido",
    utm_campaign:params.get("utm_campaign")||"nao_definido"
  };

  try{
    const res=await fetch(WEBAPP_URL,{
      method:'POST',
      body:JSON.stringify({nome,email,tipo,ebookOptIn,token:SECRET_KEY,...origem})
    });
    const text=await res.text();
    if(res.ok && text.includes('OK')){
      dualTrack('CompleteRegistration');
      await typingEffect(`Perfeito, ${nome}!`);
      if(ebookOptIn && EBOOK_URL){
        dualTrackCustom('DownloadEbook');
        await typingEffect('Voc√™ receber√° seu diagn√≥stico gratuito em at√© 24 horas e, tamb√©m, j√° enviei um e-mail com o link do e-book. Se preferir, pode acessar por aqui:');
        await typingEffect(`<a href="${EBOOK_URL}" target="_blank" rel="noopener">Baixar e-book Automa√ß√£o Inteligente</a>`);
      } else {
        await typingEffect('Tudo certo! Voc√™ receber√° seu diagn√≥stico gratuito em at√© 24 horas.');
      }
    } else {
      await typingEffect('Ocorreu um erro ao enviar seus dados. Tente novamente mais tarde.');
    }
  } catch(err){
    console.error(err);
    await typingEffect('Falha de comunica√ß√£o com o servidor.');
  }
}

start();
</script>

<style>
.typing {
  position: relative;
  color: transparent !important;
  min-width: 60px;
  height: 18px;
  background: linear-gradient(90deg, #ddd 25%, #eee 37%, #ddd 63%);
  background-size: 400% 100%;
  animation: pulse 1.2s ease-in-out infinite;
  border-radius: 10px;
}
@keyframes pulse {
  0% { background-position: 100% 0; }
  100% { background-position: 0 0; }
}
</style>
